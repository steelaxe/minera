<html>

<head>
    <title>Minera</title>
    <link rel="stylesheet" href="./assets/css/bot-test.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
</head>

<body>

    <script src="https://code.jquery.com/jquery-1.12.3.min.js" integrity="sha256-aaODHAgvwQW1bFOGXMeX+pC4PZIPsvn2h1sArYOhgXQ=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script src="./assets/js/js.cookie.js"></script>
    <script src="./assets/js/aTemplate.js"></script>
    <script src="./assets/js/talkWithBot.js"></script>
    <script>
        window.c = 0;

        // 初期
        //talkWithBot.init();

        // コントローラー定義 - コア機能以外は、ここで制御
        controller = (function () {
            return {

                recognition: null,

                init: function () {

                    // マイクの準備
                    window.SpeechRecognition = window.SpeechRecognition || webkitSpeechRecognition;
                    controller.recognition = new webkitSpeechRecognition();
                    controller.recognition.lang = 'ja';

                    // 録音終了時の処理
                    controller.recognition.addEventListener('result', function (event) {
                        var text = event.results.item(0).item(0).transcript;
                        controller.talk(talkWithBot.convId, text);
                        $("body").removeClass("_recoading");
                        console.log("録音終了");
                    }, false);

                },
                makeView: function (convId) {

                    talkWithBot.getMessage(convId)
                        .then(function (get_result) {
                            console.log(get_result.messages);
                            controller.render(get_result.messages);
                        });

                },
                talk: function (convId, msg) {

                    // DOM操作
                    $("#input").val("");

                    var send = talkWithBot.sendMessage(convId, msg);
                    var getAndRender = controller.getAndRender(convId, talkWithBot.watermark);

                    $.when(send, getAndRender)
                        .done(function (send_result, getAndRender_result) {
                            //console.log(get_result[0].messages);
                            //controller.render(get_result[0].messages);
                            c = 0;
                            controller.polling();
                        });

                },
                getAndRender: function (convId) {

                    var d = $.Deferred();

                    talkWithBot.getMessage(convId, talkWithBot.watermark)
                        .then(function (get_result) {
                            console.log(get_result.messages);
                            controller.render(get_result.messages);
                        });

                    d.resolve();
                    return d.promise();

                },
                render: function (obj) {
                    var view = new aTemplate.View({
                        templates: ["chatView"],
                        data: {
                            massages: obj
                        },
                    });
                    console.log("Rendered.");
                    view.update();
                },
                mic: function () {
                    controller.recognition.start();
                },
                speech: function (obj) {
                    var last = (obj.messages.length - 1);
                    var text = obj.messages[last].text;

                    var synthes = new SpeechSynthesisUtterance(text);
                    synthes.lang = "ja-JP"
                    speechSynthesis.speak(synthes);
                },
                polling: function () {

                    // talkWithBot.getMessage()する度にwatermarkは更新される。
                    console.log("@@@@POLLING....  " + talkWithBot.watermark);

                    var d = jQuery.Deferred();

                    $.when(controller.sleep(1000), controller.getAndRender(talkWithBot.convId))
                        .done(function () {
                            c++;
                            if (c < 3) { // 条件チェック
                                controller.polling(); //再帰呼出し
                            } else {
                                controller.speech(talkWithBot.messages);
                            }
                        });
                    d.resolve();
                    return d.promise();
                },
                sleep: function (time) {
                    var d = $.Deferred();
                    setTimeout(function () {
                        console.log("resolve#wait_time(" + time + ") ");
                        d.resolve();
                    }, time);
                    return d.promise();
                }
            }
        })();

        $(function () {

            talkWithBot.init()
                .then(function () {
                    controller.makeView(talkWithBot.convId);
                });

            controller.init();

            $("#MicButton").click(function () {
                $("body").addClass("_recoading");
                controller.mic();
            });

        });
    </script>

    <!--********************************************-->

    <ssection>
        <h2>Minera</h2>

        <table>
            <tr>
                <th>conversationId</th>
                <td id="convId"></td>
            </tr>
        </table>

        <script id="chatView" type="text/template">
            <ul class="chatView">
                <!-- BEGIN massages:loop -->
                <li class="chatView-item from_{from}">
                    <span>{text}</span>
                </li>
                <!-- END massages:loop -->
            </ul>
        </script>
<!--

        <div id="Avatar">
            (๑・▽・๑)
        </div>
-->


        <button id="MicButton">
            <i class="material-icons md-48">mic</i>
        </button>


    </ssection>

    <!--********************************************-->

</body>

</html>
