<html>

<head>
    <title>Minera</title>
    <link rel="stylesheet" href="./assets/css/bot-test.css">
</head>

<body>

    <script src="https://code.jquery.com/jquery-1.12.3.min.js" integrity="sha256-aaODHAgvwQW1bFOGXMeX+pC4PZIPsvn2h1sArYOhgXQ=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script src="./assets/js/js.cookie.js"></script>
    <script src="./assets/js/aTemplate.js"></script>
    <script src="./assets/js/talkWithBot.js"></script>
    <script>
        window.c = 0;

        // 初期
        //talkWithBot.init();

        // コントローラー定義 - コア機能以外は、ここで制御
        controller = (function () {
            return {
                makeView: function (convId) {

                    talkWithBot.getMessage(convId)
                        .then(function (get_result) {
                            console.log(get_result.messages);
                            controller.render(get_result.messages);
                        });

                },
                talk: function (convId, msg) {

                    // DOM操作
                    $("#input").val("");

                    var send = talkWithBot.sendMessage(convId, msg);
                    var getAndRender = controller.getAndRender(convId, talkWithBot.watermark);

                    $.when(send, getAndRender)
                        .done(function (send_result, getAndRender_result) {
                            //console.log(get_result[0].messages);
                            //controller.render(get_result[0].messages);
                            c = 0;
                            controller.polling();
                        });

                },
                getAndRender: function (convId) {

                    var d = $.Deferred();

                    talkWithBot.getMessage(convId, talkWithBot.watermark)
                        .then(function (get_result) {
                            console.log(get_result.messages);
                            controller.render(get_result.messages);
                        });

                    d.resolve();
                    return d.promise();

                },
                render: function (obj) {
                    var view = new aTemplate.View({
                        templates: ["chatView"],
                        data: {
                            massages: obj
                        },
                    });
                    console.log("Rendered.");
                    view.update();
                },
                speech: function (obj) {
                    var last = (obj.messages.length - 1);
                    var text = obj.messages[last].text;

                    var synthes = new SpeechSynthesisUtterance( text );
                    synthes.lang = "ja-JP"
                    speechSynthesis.speak(synthes);
                },
                polling: function () {

                    // talkWithBot.getMessage()する度にwatermarkは更新される。
                    console.log("@@@@POLLING....  " + talkWithBot.watermark);

                    var d = jQuery.Deferred();

                    $.when(controller.sleep(1000), controller.getAndRender(talkWithBot.convId))
                        .done(function () {
                            c++;
                            if (c < 3) { // 条件チェック
                                controller.polling(); //再帰呼出し
                            }else{
                               controller.speech( talkWithBot.messages );
                            }
                        });
                    d.resolve();
                    return d.promise();
                },
                sleep: function (time) {
                    var d = $.Deferred();
                    setTimeout(function () {
                        console.log("resolve#wait_time(" + time + ") ");
                        d.resolve();
                    }, time);
                    return d.promise();
                }
            }
        })();

        $(function () {

            talkWithBot.init()
                .then(function () {
                    controller.makeView(talkWithBot.convId);
                });

        });
    </script>

    <!--********************************************-->

    <ssection>
        <h2>Minera</h2>

        <table>
            <tr>
                <th>conversationId</th>
                <td id="convId"></td>
            </tr>
        </table>

        <script id="chatView" type="text/template">
            <ul class="chatView">
                <!-- BEGIN massages:loop -->
                <li class="chatView-item from_{from}">
                    <span>{text}</span>
                </li>
                <!-- END massages:loop -->
            </ul>
        </script>

        <form action="javascript: controller.talk( talkWithBot.convId, $('#input').val() );">
            <input type="text" id="input" required>
            <button>送信</button>
        </form>


    </ssection>

    <!--********************************************-->

    <hr>

    <section style="font-size:11px; opacity: 0.3;">
        <h3>Bot Privacy Policy</h3>

        <p><strong>個人情報の管理<br /></strong>当社は、お客さまの個人情報を正確かつ最新の状態に保ち、個人情報への不正アクセス・紛失・破損・改ざん・漏洩などを防止するため、セキュリティシステムの維持・管理体制の整備・社員教育の徹底等の必要な措置を講じ、安全対策を実施し個人情報の厳重な管理を行ないます。
            <br />
            <br /><strong>個人情報の利用目的<br /></strong>お客さまからお預かりした個人情報は、当社からのご連絡や業務のご案内やご質問に対する回答として、電子メールや資料のご送付に利用いたします。
            <br />
            <br /><strong>個人情報の第三者への開示・提供の禁止<br /></strong>当社は、お客さまよりお預かりした個人情報を適切に管理し、次のいずれかに該当する場合を除き、個人情報を第三者に開示いたしません。</p>
        <ul>
            <li>お客さまの同意がある場合</li>
            <li>お客さまが希望されるサービスを行なうために当社が業務を委託する業者に対して開示する場合</li>
            <li>法令に基づき開示することが必要である場合</li>
        </ul>
        <p><strong>個人情報の安全対策<br /></strong>当社は、個人情報の正確性及び安全性確保のために、セキュリティに万全の対策を講じています。
            <br />
            <br /><strong>ご本人の照会<br /></strong>お客さまがご本人の個人情報の照会・修正・削除などをご希望される場合には、ご本人であることを確認の上、対応させていただきます。
            <br />
            <br /><strong>法令、規範の遵守と見直し<br /></strong>当社は、保有する個人情報に関して適用される日本の法令、その他規範を遵守するとともに、本ポリシーの内容を適宜見直し、その改善に努めます。<strong>お問い合せ</strong>当社の個人情報の取扱に関するお問い合せは下記までご連絡ください。
            <br />okajax@outlook.jp</p>
        <p>&nbsp;</p>
    </section>

</body>

</html>
